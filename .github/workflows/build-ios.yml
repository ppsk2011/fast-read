name: Build iOS

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Capacitor sync
        run: |
          npx cap add ios
          npx cap sync ios

      - name: Install CocoaPods dependencies
        run: |
          cd ios/App
          pod install

      - name: Build (unsigned, for CI validation)
        run: |
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

      # For a real App Store build, configure signing via secrets:
      # https://docs.github.com/en/actions/deployment/deploying-xcode-applications
      #
      # - name: Build signed IPA (tags only)
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   ...
